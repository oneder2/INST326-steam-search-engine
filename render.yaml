# Render.com deployment configuration for Steam Game Search Engine
# This file defines the deployment settings for both frontend and backend services

services:
  # Frontend - Next.js Application
  - type: web
    name: steam-search-frontend
    env: node
    plan: free
    buildCommand: npm ci && npm run build
    startCommand: npm start
    healthCheckPath: /
    envVars:
      - key: NODE_ENV
        value: production
      - key: NEXT_PUBLIC_API_BASE_URL
        fromService:
          type: web
          name: steam-search-backend
          property: host
      - key: NEXT_PUBLIC_APP_URL
        fromService:
          type: web
          name: steam-search-frontend
          property: host
      - key: NEXT_PUBLIC_DEBUG
        value: false
    domains:
      - steam-game-search.onrender.com
    headers:
      - path: /*
        name: X-Frame-Options
        value: DENY
      - path: /*
        name: X-Content-Type-Options
        value: nosniff
      - path: /*
        name: Referrer-Policy
        value: strict-origin-when-cross-origin
      - path: /*
        name: Permissions-Policy
        value: camera=(), microphone=(), geolocation=()
    routes:
      - type: rewrite
        source: /api/*
        destination: https://steam-search-backend.onrender.com/api/*
    
  # Backend - Python FastAPI Application
  - type: web
    name: steam-search-backend
    env: python
    plan: free
    buildCommand: pip install -r steam-search-backend/requirements-core.txt
    startCommand: cd steam-search-backend && uvicorn main:app --host 0.0.0.0 --port $PORT
    healthCheckPath: /api/v1/health
    envVars:
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: ENVIRONMENT
        value: production
      - key: LOG_LEVEL
        value: INFO
      - key: DATABASE_URL
        value: sqlite:///data/games_data.db
      - key: FAISS_INDEX_PATH
        value: data/game_embeddings.faiss
      - key: BM25_INDEX_PATH
        value: data/bm25_index.pkl
      - key: CORS_ORIGINS
        value: https://steam-game-search.onrender.com,http://localhost:3000
      - key: API_RATE_LIMIT
        value: 100
      - key: CACHE_TTL
        value: 3600
    domains:
      - steam-search-api.onrender.com

# Database and static files (if needed)
databases: []

# Static sites (alternative frontend deployment option)
# - type: static
#   name: steam-search-static
#   buildCommand: npm ci && npm run build && npm run export
#   publishPath: out
#   pullRequestPreviewsEnabled: true
#   headers:
#     - path: /*
#       name: X-Frame-Options
#       value: DENY
#   routes:
#     - type: rewrite
#       source: /api/*
#       destination: https://steam-search-backend.onrender.com/api/*

# Environment-specific configurations
environments:
  production:
    services:
      - name: steam-search-frontend
        envVars:
          - key: NEXT_PUBLIC_GA_ID
            value: G-XXXXXXXXXX  # Replace with actual Google Analytics ID
          - key: NEXT_PUBLIC_SENTRY_DSN
            value: ""  # Add Sentry DSN for error tracking
      - name: steam-search-backend
        envVars:
          - key: SENTRY_DSN
            value: ""  # Add Sentry DSN for error tracking
          - key: LOG_LEVEL
            value: WARNING

  staging:
    services:
      - name: steam-search-frontend
        envVars:
          - key: NEXT_PUBLIC_DEBUG
            value: true
      - name: steam-search-backend
        envVars:
          - key: LOG_LEVEL
            value: DEBUG

# Build settings
build:
  commands:
    # Frontend build commands
    - name: Install frontend dependencies
      command: cd frontend && npm ci
    - name: Build frontend
      command: cd frontend && npm run build
    
    # Backend build commands  
    - name: Install backend dependencies
      command: cd backend && pip install -r requirements.txt
    - name: Prepare data files
      command: cd backend && python scripts/prepare_data.py

# Health checks
healthChecks:
  frontend:
    path: /
    intervalSeconds: 30
    timeoutSeconds: 10
    unhealthyThresholdCount: 3
    healthyThresholdCount: 2
  
  backend:
    path: /api/v1/health
    intervalSeconds: 30
    timeoutSeconds: 10
    unhealthyThresholdCount: 3
    healthyThresholdCount: 2

# Scaling settings
scaling:
  frontend:
    minInstances: 1
    maxInstances: 3
    targetCPUPercent: 70
  
  backend:
    minInstances: 1
    maxInstances: 5
    targetCPUPercent: 80

# Monitoring and alerts
monitoring:
  alerts:
    - name: High Error Rate
      condition: error_rate > 5%
      duration: 5m
      channels:
        - email
    - name: High Response Time
      condition: response_time_p95 > 2s
      duration: 5m
      channels:
        - email
    - name: Low Availability
      condition: availability < 99%
      duration: 10m
      channels:
        - email

# Backup settings (for data files)
backups:
  - name: game-data-backup
    schedule: "0 2 * * *"  # Daily at 2 AM
    retention: 7  # Keep 7 days of backups
    paths:
      - data/games_data.db
      - data/game_embeddings.faiss
      - data/bm25_index.pkl

# Security settings
security:
  headers:
    - name: Strict-Transport-Security
      value: max-age=31536000; includeSubDomains
    - name: Content-Security-Policy
      value: default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'
  
  cors:
    allowedOrigins:
      - https://steam-game-search.onrender.com
      - http://localhost:3000
    allowedMethods:
      - GET
      - POST
      - OPTIONS
    allowedHeaders:
      - Content-Type
      - Authorization
      - X-Requested-With

# Performance optimizations
performance:
  compression: true
  caching:
    static:
      maxAge: 31536000  # 1 year for static assets
    api:
      maxAge: 3600  # 1 hour for API responses
  
  cdn:
    enabled: true
    regions:
      - us-east-1
      - us-west-2
      - eu-west-1

# Logging configuration
logging:
  level: INFO
  format: json
  destinations:
    - console
    - file
  retention: 30  # days

# Custom domains and SSL
domains:
  - name: steamgamesearch.com
    service: steam-search-frontend
    ssl: true
  - name: api.steamgamesearch.com
    service: steam-search-backend
    ssl: true
