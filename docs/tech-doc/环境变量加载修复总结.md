# ç¯å¢ƒå˜é‡åŠ è½½ä¿®å¤æ€»ç»“

## ğŸ”´ é—®é¢˜æè¿°

åç«¯å¯åŠ¨æ—¶å‡ºç° "Invalid API key" é”™è¯¯ï¼Œå³ä½¿ `.env` æ–‡ä»¶ä¸­åŒ…å«æ­£ç¡®çš„ `SUPABASE_KEY`ã€‚

**é”™è¯¯æ—¥å¿—**:
```
âš ï¸  System environment variable SUPABASE_URL is set (may override .env)
âš ï¸  System environment variable SUPABASE_KEY is set (may override .env)
ERROR - Failed to initialize Supabase client: Invalid API key
```

## ğŸ” æ ¹æœ¬åŸå› 

1. **æ¨¡å—çº§åˆ«åˆå§‹åŒ–è¿‡æ—©**: `supabase.py` å’Œ `database.py` åœ¨æ¨¡å—å¯¼å…¥æ—¶å°±è°ƒç”¨ `get_settings()`ï¼Œæ­¤æ—¶ç¯å¢ƒå˜é‡å¯èƒ½è¿˜æœªæ­£ç¡®åŠ è½½
2. **ç³»ç»Ÿç¯å¢ƒå˜é‡è¦†ç›–**: å¦‚æœç³»ç»Ÿç¯å¢ƒå˜é‡è¢«è®¾ç½®ï¼ˆå³ä½¿æ˜¯ç©ºå€¼ï¼‰ï¼ŒPydantic Settings ä¼šä¼˜å…ˆä½¿ç”¨ç³»ç»Ÿç¯å¢ƒå˜é‡ï¼Œè€Œä¸æ˜¯ `.env` æ–‡ä»¶
3. **åŠ è½½é¡ºåºé—®é¢˜**: Pydantic Settings çš„ `env_file` ç›¸å¯¹è·¯å¾„è§£æå¯èƒ½åœ¨å·¥ä½œç›®å½•ä¸æ­£ç¡®æ—¶å¤±è´¥

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. ç§»é™¤æ¨¡å—çº§åˆ«çš„ settings è°ƒç”¨

**ä¿®æ”¹æ–‡ä»¶**:
- `app/data/providers/supabase.py`
- `app/data/providers/database.py`

**ä¿®æ”¹å†…å®¹**:
```python
# ä¿®æ”¹å‰ï¼ˆé”™è¯¯ï¼‰:
settings = get_settings()  # æ¨¡å—çº§åˆ«è°ƒç”¨

# ä¿®æ”¹åï¼ˆæ­£ç¡®ï¼‰:
# åœ¨ __init__ æ–¹æ³•ä¸­è°ƒç”¨
def __init__(self, ...):
    current_settings = get_settings()
    self.supabase_url = supabase_url or current_settings.supabase_url
    ...
```

### 2. æ·»åŠ æ˜¾å¼çš„ .env æ–‡ä»¶åŠ è½½

**ä¿®æ”¹æ–‡ä»¶**: `app/config/settings.py`

**å…³é”®ä¿®æ”¹**:
```python
def get_settings() -> Settings:
    global _settings
    if _settings is None:
        # 1. æ£€æŸ¥ .env æ–‡ä»¶ä½ç½®
        cwd = Path.cwd()
        env_file_path = cwd / ".env"
        
        # 2. ä½¿ç”¨ python-dotenv æ˜¾å¼åŠ è½½ .env æ–‡ä»¶
        # override=True ç¡®ä¿ .env æ–‡ä»¶è¦†ç›–ç³»ç»Ÿç¯å¢ƒå˜é‡
        if env_file_path.exists():
            from dotenv import load_dotenv
            load_dotenv(env_file_path, override=True)
        
        # 3. åˆ›å»º Settings å®ä¾‹
        _settings = Settings()
        
        # 4. éªŒè¯é…ç½®æ˜¯å¦åŠ è½½æˆåŠŸ
        if not _settings.supabase_url or not _settings.supabase_key:
            logger.error("âŒ Supabase configuration missing!")
```

### 3. ä¿®å¤ Pydantic v2 é…ç½®è­¦å‘Š

**ä¿®æ”¹æ–‡ä»¶**:
- `app/api/schemas/search.py`
- `app/api/schemas/game.py`

**ä¿®æ”¹å†…å®¹**:
```python
# Pydantic v1 (æ—§):
class Config:
    allow_population_by_field_name = True
    schema_extra = {...}

# Pydantic v2 (æ–°):
class Config:
    populate_by_name = True  # æ›¿ä»£ allow_population_by_field_name
    json_schema_extra = {...}  # æ›¿ä»£ schema_extra
```

## ğŸ“‹ ä¿®å¤åçš„å·¥ä½œæµç¨‹

1. **å¯åŠ¨è„šæœ¬**: `python3 main.py` (ä» `backend-INST326-steam-search/` ç›®å½•è¿è¡Œ)
2. **å·¥ä½œç›®å½•**: `backend-INST326-steam-search/`
3. **.env æ–‡ä»¶ä½ç½®**: `backend-INST326-steam-search/.env`
4. **åŠ è½½é¡ºåº**:
   - é¦–å…ˆä½¿ç”¨ `python-dotenv` åŠ è½½ `.env` æ–‡ä»¶ï¼ˆ`override=True`ï¼‰
   - ç„¶å Pydantic Settings è¯»å–ç¯å¢ƒå˜é‡
   - `.env` æ–‡ä»¶çš„å€¼ä¼šè¦†ç›–ç³»ç»Ÿç¯å¢ƒå˜é‡

## âœ… éªŒè¯æ–¹æ³•

é‡å¯åç«¯æœåŠ¡åï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```
ğŸ” Loading settings from working directory: /path/to/backend-INST326-steam-search
ğŸ” Looking for .env file at: /path/to/backend-INST326-steam-search/.env
ğŸ” .env file exists: True
âœ… Manually loaded .env file using python-dotenv (overriding system env vars)
âœ… SUPABASE_URL loaded: https://bcaoujpzhoyrinhaydyu.s...
âœ… SUPABASE_KEY loaded (length: 46)
ğŸ” SupabaseProvider: Calling get_settings()...
ğŸ” SupabaseProvider: Settings loaded, URL present: True, Key present: True
ğŸ” SupabaseProvider: Using URL: https://bcaoujpzhoyrinhaydyu.s...
ğŸ” SupabaseProvider: Using Key length: 46
ğŸ” SupabaseProvider: Key starts with: sb_publishab...
```

## ğŸ”§ æœ€æ–°ä¿®å¤ï¼ˆ2024-12-19ï¼‰

### é—®é¢˜
æ—¥å¿—ä¸­æ²¡æœ‰æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯ï¼Œæ— æ³•è¯Šæ–­ç¯å¢ƒå˜é‡åŠ è½½é—®é¢˜ã€‚

### ä¿®å¤
1. **åœ¨ `main.py` ä¸­å…ˆè®¾ç½®åŸºæœ¬æ—¥å¿—**ï¼šåœ¨è°ƒç”¨ `get_settings()` ä¹‹å‰é…ç½®åŸºæœ¬æ—¥å¿—ï¼Œç¡®ä¿é…ç½®åŠ è½½è¿‡ç¨‹çš„æ—¥å¿—èƒ½å¤Ÿè¾“å‡º
2. **åœ¨ `supabase.py` ä¸­æ·»åŠ è¯¦ç»†è°ƒè¯•æ—¥å¿—**ï¼šæ˜¾ç¤ºå®é™…ä½¿ç”¨çš„ URL å’Œ key çš„å€¼ï¼ˆéƒ¨åˆ†éšè—ï¼‰ï¼Œå¸®åŠ©è¯Šæ–­é—®é¢˜
3. **æ”¹è¿›é”™è¯¯æ—¥å¿—**ï¼šåœ¨ Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥æ—¶ï¼Œæ˜¾ç¤ºå®é™…ä½¿ç”¨çš„å€¼

### å…³é”®ä»£ç ä¿®æ”¹

**`app/main.py`**:
```python
# å…ˆè®¾ç½®åŸºæœ¬æ—¥å¿—ï¼ˆåœ¨åŠ è½½é…ç½®ä¹‹å‰ï¼‰
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# ç„¶åè·å–é…ç½®ï¼ˆä¼šè¾“å‡ºè¯¦ç»†è°ƒè¯•ä¿¡æ¯ï¼‰
settings = get_settings()

# é‡æ–°è®¾ç½®æ—¥å¿—ï¼ˆä½¿ç”¨é…ç½®ä¸­çš„æ—¥å¿—çº§åˆ«å’Œæ ¼å¼ï¼‰
setup_logging(settings.log_level, settings.log_format)
```

**`app/data/providers/supabase.py`**:
```python
# æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
logger.info("ğŸ” SupabaseProvider: Calling get_settings()...")
current_settings = get_settings()
logger.info(f"ğŸ” SupabaseProvider: Settings loaded, URL present: {bool(current_settings.supabase_url)}, Key present: {bool(current_settings.supabase_key)}")
logger.info(f"ğŸ” SupabaseProvider: Using URL: {self.supabase_url[:30] + '...'}")
logger.info(f"ğŸ” SupabaseProvider: Using Key length: {len(self.supabase_key)}")
logger.info(f"ğŸ” SupabaseProvider: Key starts with: {self.supabase_key[:10] + '...'}")
```

## ğŸ¯ å…³é”®ä¿®å¤ç‚¹

1. âœ… **æ¨¡å—çº§åˆ«è°ƒç”¨ç§»é™¤**: ç¡®ä¿åœ¨æ­£ç¡®çš„æ—¶æœºåŠ è½½é…ç½®
2. âœ… **æ˜¾å¼ .env åŠ è½½**: ä½¿ç”¨ `python-dotenv` ç¡®ä¿ `.env` æ–‡ä»¶è¢«åŠ è½½
3. âœ… **è¦†ç›–ç³»ç»Ÿç¯å¢ƒå˜é‡**: `override=True` ç¡®ä¿ `.env` æ–‡ä»¶ä¼˜å…ˆ
4. âœ… **è¯¦ç»†æ—¥å¿—**: æ·»åŠ è¯Šæ–­ä¿¡æ¯å¸®åŠ©æ’æŸ¥é—®é¢˜
5. âœ… **Pydantic v2 å…¼å®¹**: ä¿®å¤é…ç½®è­¦å‘Š

## ğŸ“ æ³¨æ„äº‹é¡¹

- **å·¥ä½œç›®å½•**: å¿…é¡»ä» `backend-INST326-steam-search/` ç›®å½•è¿è¡Œ `python3 main.py`
- **.env æ–‡ä»¶**: å¿…é¡»ä½äº `backend-INST326-steam-search/.env`
- **ç¯å¢ƒå˜é‡å**: ä½¿ç”¨ `SUPABASE_URL` å’Œ `SUPABASE_KEY`ï¼ˆä¸æ˜¯ `NEXT_PUBLIC_*`ï¼‰
- **ç³»ç»Ÿç¯å¢ƒå˜é‡**: å¦‚æœç³»ç»Ÿç¯å¢ƒå˜é‡è¢«è®¾ç½®ï¼Œ`.env` æ–‡ä»¶ä¼šè¦†ç›–å®ƒä»¬ï¼ˆ`override=True`ï¼‰

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2024-12-19  
**çŠ¶æ€**: âœ… å®Œæˆ

